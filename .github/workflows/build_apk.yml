name: Android CI - Build APK with Chinese Resources

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # 检查中文资源文件
      - name: Validate Chinese Resource
        run: |
          echo "检查资源文件结构："
          ls -R app/src/main/res/
          
          if [ ! -f "app/src/main/res/values-cn/strings.xml" ]; then
            echo "❌ 中文资源文件不存在"
            exit 1
          fi
          echo "✅ 找到中文资源文件，内容预览："
          head -n 5 app/src/main/res/values-cn/strings.xml

      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'gradle'

      # 清理和权限设置
      - name: Prepare environment
        run: |
          chmod +x ./gradlew
          ./gradlew clean

      # 构建和调试
      - name: Build with debug info
        run: |
          ./gradlew assembleDebug --stacktrace --info
          echo "检查中间资源文件："
          find app/build/intermediates/merged_res/debug/ -name "strings.xml" | xargs ls -la

      # 改进的资源验证步骤
      - name: Verify Chinese resources
        run: |
          echo "===== APK资源列表 ====="
          unzip -l app/build/outputs/apk/debug/*.apk | grep "values-" || echo "⚠️ 未找到任何values目录"
          
          echo "===== 尝试提取中文资源 ====="
          if unzip -p app/build/outputs/apk/debug/*.apk "res/values-cn/strings.xml" > /tmp/cn.xml 2>/dev/null; then
            echo "✅ 成功提取中文资源："
            cat /tmp/cn.xml
          else
            echo "❌ 错误：APK中未找到中文资源"
            echo "可能原因："
            echo "1. 检查app/build.gradle是否包含: resConfigs 'cn'"
            echo "2. 确认文件路径为: app/src/main/res/values-cn/strings.xml"
            echo "3. 文件编码应为UTF-8无BOM"
            exit 1
          fi

      # 上传产物
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: apk-artifacts
          path: |
            app/build/outputs/apk/debug/*.apk
            app/build/reports/
          retention-days: 3
